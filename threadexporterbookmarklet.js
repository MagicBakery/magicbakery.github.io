javascript:(function(){const mVersion="20251103012800";const FEED_SEL='[data-testid="feed-container"]';const PANEL_ID='gemini-injection-div';const BASE_COLOR='#f0f8ff';let isCodenameMode=true;function escapeHtml(str){return str?str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,">").replace(/"/g,'"').replace(/'/g,"'"):""}function escapeForAiExport(str){if(!str)return "";let cleaned=str.trim();return cleaned.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"').replace(/&#39;/g,"'")}let old=document.getElementById(PANEL_ID);if(old)old.remove();const feed=document.querySelector(FEED_SEL);if(!feed){console.error(`Thread Exporter: Target feed container not found: ${FEED_SEL}`);return}const panel=document.createElement("div");panel.id=PANEL_ID;panel.style.cssText=`position:relative;max-height:80vh;overflow-y:hidden;padding:10px;padding-top:50px;margin-bottom:1rem;background:${BASE_COLOR};border:1px solid #1e90ff;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,0.1);font-family:Inter,sans-serif;transition:background-color 0.5s;`;const header=document.createElement("div");header.style.cssText="position:absolute;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:rgba(255,255,255,.95);border-bottom:1px solid #1e90ff;border-radius:8px 8px 0 0;z-index:10;";const title=document.createElement("span");title.textContent="Thread Exporter "+mVersion;title.style.cssText="font-weight:bold;color:black;padding:4px;cursor:pointer;";title.title="Click to show/hide content";const controls=document.createElement("div");controls.style.cssText="display:flex;gap:6px;align-items:center;";const btnAnalyze=document.createElement("button");btnAnalyze.style.cssText="background:none;border:none;cursor:pointer;padding:4px;display:flex;align-items:center;justify-content:center;border-radius:4px;transition:background-color 0.2s;color:#1e90ff;transform:scale(1);";btnAnalyze.innerHTML='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.5 9a9 9 0 0 1 14.5-5.5L23 10M1 14l4.5 5.5A9 9 0 0 0 20.5 15"></path></svg>';btnAnalyze.title='Analyze/Refresh Content';const btnClose=document.createElement("button");btnClose.style.cssText="background:none;border:none;cursor:pointer;padding:4px;display:flex;align-items:center;justify-content:center;border-radius:4px;transition:background-color 0.2s;color:#f44336;transform:scale(1);";btnClose.innerHTML='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';btnClose.title='Close Panel';const content=document.createElement("div");content.style.cssText="padding-bottom: 5px; display: block;";controls.appendChild(btnAnalyze);controls.appendChild(btnClose);header.appendChild(title);header.appendChild(controls);panel.appendChild(header);panel.appendChild(content);feed.parentNode.insertBefore(panel,feed);title.addEventListener('click',()=>{content.style.display=content.style.display==='none'?'block':'none'});let threadData=[];function analyze(){panel.style.backgroundColor='#f0fff0';isCodenameMode=true;threadData=[];const threadRoot=document.querySelector('div[id^="feedItem"]');const replyBtn=document.querySelector('[data-testid="post-reply-button"]');let totalCount="N/A";if(replyBtn){let spans=replyBtn.querySelectorAll("span");if(spans.length){totalCount=spans[spans.length-1].textContent.trim().replace(/\D/g,"")||"N/A"}}let allParticipantLinks=[];if(threadRoot){threadRoot.querySelectorAll('a[href$="feed_author"],a[href$="feed_commenter"]').forEach(a=>{if(a.children.length===0)allParticipantLinks.push(a)})}const participantMap=new Map();let commenterCount=0;allParticipantLinks.forEach(link=>{const authorName=link.textContent.trim();const isOp=link.href.endsWith("feed_author");const userProfileId=link.href.match(/\/profile\/([^/?]+)/)?.[1];const uniqueKey=userProfileId||(isOp?'OP_UNIQUE_KEY':authorName);if(!participantMap.has(uniqueKey)){let assignedCodename='';if(isOp){assignedCodename='OP'}else{assignedCodename=`C${String(++commenterCount).padStart(3,'0')}`}participantMap.set(uniqueKey,{codename:assignedCodename,realName:authorName,uniqueId:userProfileId||'N/A'})}});const visibleCommenters=allParticipantLinks.filter(link=>link.href.endsWith("feed_commenter")).length;let authorListHtml='';const baseUrl=location.href.split("?")[0];let displayIndex=0;allParticipantLinks.forEach(link=>{const authorName=link.textContent.trim();const isOp=link.href.endsWith("feed_author");const contentId=`c${displayIndex}`;const userProfileId=link.href.match(/\/profile\/([^/?]+)/)?.[1];const uniqueKey=userProfileId||(isOp?'OP_UNIQUE_KEY':authorName);const participantData=participantMap.get(uniqueKey)||{codename:'Unknown',realName:authorName,uniqueId:'N/A'};const assignedCodename=participantData.codename;const uniqueUserIdDisplay=participantData.uniqueId;const initialDisplayName=isCodenameMode?assignedCodename:authorName;let commentText="Comment text not found.";let url="#";if(isOp){let opContainer=threadRoot||document;let el=opContainer.querySelector('[data-testid="post-body"]');if(el)commentText=el.textContent.trim();url=baseUrl}else{let box=link.closest('[id^="comment_"]');if(box){let body=box.querySelector('[data-testid="comment-detail-body"]');if(body)commentText=body.textContent.trim();let id=(box.id||"").split("_").pop();url=`${baseUrl}/c/${id}`}}threadData.push({index:displayIndex,codename:assignedCodename,realName:authorName,text:commentText});authorListHtml+=`%0A <div style="font-size: 0.9em; padding: 0 0; line-height: 1.5; margin-bottom: 4px;">%0A [${displayIndex}] <a href="${url}" target="_blank" class="cex-author"%0A data-cid="${contentId}"%0A data-codename="${assignedCodename}"%0A data-realname="${authorName}"%0A data-unique-id="${uniqueUserIdDisplay}"%0A title="${isCodenameMode?`Real Name: ${authorName} | ID: ${uniqueUserIdDisplay}`:`Codename: ${assignedCodename}`}"%0A style="color: #007bff; text-decoration: none; cursor: pointer;">${initialDisplayName}</a>%0A </div>`;authorListHtml+=`%0A <div id="${contentId}" style="display:none;padding:5px;margin-bottom:5px;;max-height:200px;overflow-y:auto;text-indent:0;font-size:0.9em;background-color:white;border-radius:4px;">%0A ${escapeHtml(commentText)}%0A </div>%0A `;displayIndex++});const analyzedAndButtonHtml=`%0A <div style="display: flex; justify-content: space-between; align-items: center; margin: 0; padding-bottom: 0.5rem; flex-wrap: wrap;">%0A <p style="font-size: 0.8em; margin: 0;">Last Analyzed: ${(new Date()).toLocaleTimeString()}</p>%0A <div style="display: flex; align-items: center; gap: 10px;">%0A <input type="checkbox" id="toggle-codename-cb" ${isCodenameMode?'checked':''} title="Toggle Codename/Real Name" style="cursor: pointer;">%0A <button id="export-thread-btn" style="%0A padding: 5px 10px;%0A background: #2196F3;%0A color: white;%0A border: none;%0A border-radius: 4px;%0A cursor: pointer;%0A font-size: 0.8em;%0A transition: background 0.3s;%0A white-space: nowrap;%0A ">%0A Export%0A </button>%0A </div>%0A </div>%0A `;const statusLineHtml=`%0A <div style="margin: 0; padding-bottom: 0.5rem;">%0A <p style="margin: 0; font-size: 0.9em;">Loaded <span style="font-weight: bold; color: #4CAF50;">${visibleCommenters}/${totalCount}</span>.</p>%0A </div>%0A `;const footerHtml=`<p style="font-size: 0.8em; border-top: 1px dashed #ccc; padding-top: 5px; margin-top: 10px;">Please visit <a href="https://magicbakery.github.io/?id=P`+mVersion+`" target="_blank" style="color: #007bff; text-decoration: none;">Magic Bakery</a> for updates of this bookmarklet.</p>`;let errorHtml='';if(!threadRoot){errorHtml='<p style="margin: 1rem 0 0.5rem 0; font-size: 1em; color: #f44336; font-weight: bold;">Error: First thread container (div[id^="feedItem"]) not found.</p>'}content.innerHTML=`%0A ${errorHtml}%0A ${analyzedAndButtonHtml} %0A ${statusLineHtml} %0A %0A <div style="max-height: 40vh; overflow-y: auto; padding-right: 5px; border-top: 1px solid #ddd; margin-top: 5px; padding-top: 5px;">%0A ${authorListHtml}%0A </div>%0A %0A ${footerHtml}%0A `;const toggleCb=document.getElementById('toggle-codename-cb');const exportBtn=document.getElementById('export-thread-btn');const toggleNames=(isInit=false)=>{if(!isInit){isCodenameMode=toggleCb.checked}document.querySelectorAll(".cex-author").forEach(a=>{a.textContent=isCodenameMode?a.dataset.codename:a.dataset.realname;a.title=isCodenameMode?`Real Name: ${a.dataset.realname} | ID: ${a.dataset.uniqueId}`:`Codename: ${a.dataset.codename}`})};const exportData=()=>{if(!threadData||threadData.length===0){exportBtn.textContent='No Data!';setTimeout(()=>{exportBtn.textContent='Export'},1500);return}let output="--- Thread Analysis Data ---\n\n";threadData.forEach(item=>{const name=isCodenameMode?item.codename:item.realName;const text=escapeForAiExport(item.text);output+=`[${item.index}] ${name}:\n`;output+=`> ${text.replace(/\n/g,'\n> ')}\n\n`});navigator.clipboard.writeText(output).then(()=>{exportBtn.textContent='Copied!';exportBtn.style.backgroundColor='#4CAF50';setTimeout(()=>{exportBtn.textContent='Export';exportBtn.style.backgroundColor='#2196F3'},1500)}).catch(err=>{console.error('Could not copy text: ',err);exportBtn.textContent='Failed!';exportBtn.style.backgroundColor='#f44336';setTimeout(()=>{exportBtn.textContent='Export';exportBtn.style.backgroundColor='#2196F3'},1500)})};if(toggleCb){toggleNames(true);toggleCb.addEventListener('change',()=>toggleNames(false))}if(exportBtn){exportBtn.addEventListener('click',exportData)}document.querySelectorAll(".cex-author").forEach(a=>{a.addEventListener("click",e=>{if(e.button!==0)return;e.preventDefault();let box=document.getElementById(a.dataset.cid);if(box)box.style.display=box.style.display==="none"?"block":"none"});a.addEventListener("contextmenu",e=>{})});setTimeout(()=>{panel.style.backgroundColor=BASE_COLOR},500)}btnAnalyze.onclick=analyze;btnClose.onclick=()=>panel.remove();analyze()})();